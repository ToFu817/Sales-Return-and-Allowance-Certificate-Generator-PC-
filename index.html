<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æŠ˜è®“å–®ç”¢ç”Ÿå™¨</title>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* page & UI */
  :root{ --a4-w-mm:210; --a4-h-mm:297; }
  body{ font-family:"æ¨™æ¥·é«”","DFKai-SB","PMingLiU","Microsoft JhengHei","Noto Sans TC",sans-serif; margin:18px; background:#f2f2f2; color:#111; }
  .wrap{ max-width:1100px; margin:0 auto; display:grid; grid-template-columns:1fr; gap:14px; align-items:start; }
  .panel{ background:#fff; padding:14px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.06); }
  h1{ font-size:16px; margin:0 0 8px 0; text-align:left; }
  label{ display:block; font-size:12px; margin:6px 0 3px; }
  input[type=text], input[type=date], input[type=number]{ width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:14px; }
  .row{ display:flex; gap:12px; margin-bottom:12px; }
  .col{ flex:1; min-width:140px; }
  button{ background:#222; color:#fff; border:none; padding:12px 12px; border-radius:6px; cursor:pointer; }
  button.secondary{ background:#888; }

  table{ width:100%; border-collapse:collapse; font-size:12px; }
  table th, table td{ border:1px solid #d0d0d0; padding:6px; vertical-align:middle; }
  table th{ background:#fafafa; font-weight:700; text-align:center; }
  .muted{ color:#666; font-size:12px; }

  /* Preview area (right column) */
  .preview-wrap{ position:relative; }
  .preview-title{ font-weight:700; margin-bottom:12px; }
  .preview{ background:#fff; border:1px solid #cfcfcf; padding:12px; border-radius:6px; }
  .preview-note{ font-size:12px; color:#666; margin-top:12px; }

  /* A4 pages in preview - scale for screen */
  .a4-container{ width:210mm; /* real A4 width */ margin:12px auto; background:#fff; box-shadow:0 4px 18px rgba(0,0,0,0.08); }
  .a4page{ width:210mm; height:297mm; padding:12mm; box-sizing:border-box; font-size:12px; color:#111; background:#fff; }
  .page-grid{ display:flex; flex-direction:column; gap:8mm; height:100%; }

  /* single copy box (half page) */
  .copy{ border:1px solid #999; padding:12px; box-sizing:border-box; min-height:calc(50% - 12px); display:flex; flex-direction:column; }
  .hdr{ display:flex; justify-content:space-between; gap:12px; }
  .hdr .left{ width:60%; border:1px solid #444; padding:6px; box-sizing:border-box; }
  .hdr .right{ width:38%; text-align:right; box-sizing:border-box; }

  .title-center{ text-align:center; font-weight:700; font-size:14px; margin-bottom:4px; }
  .small{ font-size:12px; color:#333; }

  .items-table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:12px; }
  .items-table td.right, .items-table th.right {
  text-align: right;
}

  .items-table th{ background:#f6f6f6; text-align:center; }

  /* åˆè¨ˆé¡¯ç¤ºåœ¨è¡¨æ ¼åº•éƒ¨ï¼ˆtfootï¼‰é ä¸‹ */
  .items-table tfoot td{ font-weight:700; text-align:right; vertical-align:bottom; padding-bottom:6px; }

  /* bottom area: left-block (buyer) & right-block (totals + signature) */
  .bottom{ display:flex; justify-content:space-between; gap:12px; margin-top:12px; }
  .left-block{ width:60%; border:1px solid #444; padding:6px; box-sizing:border-box; }
  .right-block{ width:38%; text-align:right; box-sizing:border-box; }

  .signature-box{ border:1px solid #444; width:160px; height:56px; display:inline-block; margin-top:12px; }

  /* dashed separator (not necessary in PDF but kept) */
  .dashed{ border-top:2px dashed #666; margin:12px 0; }

  /* right vertical label (ç›´æ›¸) */
  .vertical-label{ 
position:absolute; 
right:45mm;       /* å¾€æ¡†æ¡†æ—é‚Šé ä¸€é» */ 
top:30%; 
writing-mode: vertical-rl; /* ç›´æ›¸ */ 
text-orientation:upright; 
font-weight:700; 
font-size:12px; 
color:#333; 
}

  /* responsive: make UI single column on narrow screens */
  @media (max-width:1200px){
    .wrap{ grid-template-columns:1fr; }
    .a4-container{ transform:scale(0.7); transform-origin:top left; width:297mm; } /* scale preview for mobile */
  }

/* ä¸­é–“è™›ç·šï¼Œç”¨ä¾†å€åˆ†ä¸Šä¸‹å…©è¯ */
.page-divider {
  position: absolute;
  top: 25%;
  left: 0;
  width: 100%;
  border-top: 2px dashed #666;
  transform: translateY(-1px);
  z-index: 10;
}
/* ç¢ºä¿ a4 page æœ‰å®šä½ä¸Šä¸‹æ–‡ï¼Œè®“çµ•å°å®šä½çš„ page-divider ä»¥æ¯é ç‚ºåŸºæº– */
.a4page {
  position: relative; /* æ–°å¢ï¼šéå¸¸é‡è¦ */
  width:210mm;
  height:297mm;
  padding:12mm;
  box-sizing:border-box;
  font-size:12px;
  color:#111;
  background:#fff;
}

/* ä¸­é–“è™›ç·šï¼Œç”¨ä¾†å€åˆ†ä¸Šä¸‹å…©è¯ï¼ˆä»¥ .a4page ç‚ºåƒè€ƒï¼‰ */
.page-divider {
  position: absolute;
  top: 50%;          /* ä»¥ .a4page çš„é«˜åº¦ç‚ºåŸºæº– */
  left: 12mm;        /* èˆ‡é é‚Šè·å°é½Šï¼ˆå¯èª¿ï¼‰ */
  right: 12mm;       /* èˆ‡é é‚Šè·å°é½Šï¼ˆå¯èª¿ï¼‰ */
  border-top: 2px dashed #666;
  transform: translateY(-1px);
  z-index: 10;
  pointer-events: none; /* ä¸æœƒæ””æˆªæ»‘é¼ äº‹ä»¶ */
}


/* ğŸ”¶ åŸé€²è²¨äººç‡Ÿæ¥­äºº(æˆ–åŸè²·å—äºº) æ¬„ä½æ¨£å¼ */
.row.buyer-name {
  display: flex;
  align-items: center;
  margin-bottom: 4px;
}

.row.buyer-name .label {
  flex: 0 0 80mm; /* å·¦é‚Šæ¨™ç±¤å¯¬åº¦ */
  font-weight: bold;
}

.row.buyer-name .value {
  flex: 1; /* è‡ªå‹•æ’æ»¿å³é‚Š */
  border: 2px solid red; /* æ”¹æˆç´…æ¡† */
  padding: 3px 6px;
  min-height: 20px;
  border-radius: 4px; /* å¯æœ‰å¯ç„¡ï¼Œçœ‹ä½ æƒ³ä¸æƒ³åœ“è§’ */
}


/* ğŸ”¹ PDF ç”Ÿæˆå°ˆç”¨æ¨£å¼ï¼Œå¢åŠ é–“è· */
.pdf-mode .a4page,
.pdf-mode .copy,
.pdf-mode .items-table td,
.pdf-mode .items-table th,
.pdf-mode .hdr div,
.pdf-mode .bottom div,
.pdf-mode .title-center,
.pdf-mode .vertical-label {
  letter-spacing: 2px !important; /* PDF ä¹Ÿå¥—ç”¨å­—é–“è· */
}



/* ğŸ”¹ å…¨å±€å­—é–“è· */
body, input, select, textarea, .preview, .a4page, .copy, .items-table td, .items-table th, .hdr div, .bottom div, .title-center, .vertical-label {
  letter-spacing: 2px; /* èª¿æ•´é€™å€‹å€¼å³å¯å¢æ¸›å­—é–“è· */
}








</style>
</head>
<body>

<div class="wrap">
  <!-- left: inputs -->
  <div class="panel">
    <h1>æŠ˜è®“å–®è¼¸å…¥</h1>

    <div class="row">
      <div class="col"><label>åŸé–‹ç«‹éŠ·è²¨ç™¼ç¥¨å–®ä½å…¬å¸åç¨±</label><input id="seller_name" type="text" placeholder="â—¯â—¯æœ‰é™å…¬å¸"></div>
      <div class="col"><label>ç‡Ÿåˆ©äº‹æ¥­çµ±ä¸€ç·¨è™Ÿ</label><input id="seller_tax" type="text" placeholder="00000000"></div>
      <div class="col"><label>ç‡Ÿæ¥­æ‰€åœ¨åœ°å€</label><input id="seller_addr" type="text" placeholder="æ¡ƒåœ’å¸‚......"></div>
    </div>

    <div class="row">
      <div class="col"><label>åŸé€²è²¨äººç‡Ÿæ¥­äººåç¨±(æˆ–åŸè²·å—äºº)</label><input id="buyer_name" type="text" placeholder="â—¯â—¯æœ‰é™å…¬å¸"></div>
      <div class="col"><label>ç‡Ÿåˆ©äº‹æ¥­çµ±ä¸€ç·¨è™Ÿ(æˆ–èº«åˆ†è­‰å­—è™Ÿ)</label><input id="buyer_tax" type="text" placeholder="00000000"></div>
      <div class="col"><label>åœ°å€</label><input id="buyer_addr" type="text" placeholder="æ¡ƒåœ’å¸‚......"></div>
    </div>

    <div class="row">
      <div class="col"><label>æŠ˜è®“å–®æ—¥æœŸ</label><input id="nota_date" type="date"></div>
      <div class="col"><label>æŠ˜è®“å–®ç·¨è™Ÿ</label><input id="nota_no" type="text" placeholder="ï¼ˆé¸å¡«ï¼‰"></div>
      <div class="col"><label>å‚™è¨»</label><input id="nota_note" type="text" placeholder="ï¼ˆé¸å¡«ï¼‰"></div>
    </div>

    <hr style="border:none;height:1px;background:#eee;margin:12px 0;">

    <div style="font-weight:700; margin-bottom:12px;">æ–°å¢ç™¼ç¥¨æ˜ç´°</div>
<div class="row">
  <div style="flex:1">
    <label>è¯å¼</label>
    <select id="inv_type" style="width:100%; height:32px; box-sizing:border-box;">
      <option value="ä¸‰" selected>ä¸‰</option>
      <option value="äºŒ">äºŒ</option>
    </select>
  </div>

  <div style="flex:1">
    <label>åŸç™¼ç¥¨æ—¥æœŸ</label>
    <input id="inv_date" type="date" style="width:100%; height:32px; box-sizing:border-box;">
  </div>

  <div style="flex:1">
    <label>åŸç™¼ç¥¨è™Ÿç¢¼</label>
    <input id="inv_no" type="text" style="width:100%; height:32px; box-sizing:border-box;">
  </div>

  <div style="flex:2">
    <label>å“å / èªªæ˜</label>
    <input id="item_desc" type="text" style="width:100%; height:32px; box-sizing:border-box;">
  </div>

  <div style="width:90px">
    <label>æ•¸é‡</label>
    <input id="item_qty" type="number" min="1" value="1" style="width:100%; height:32px; box-sizing:border-box;">
  </div>

  <div style="width:140px">
    <label>å–®åƒ¹ï¼ˆæœªç¨…ï¼‰</label>
    <input id="item_price" type="number" min="0" step="0.01" value="0" style="width:100%; height:32px; box-sizing:border-box;">
  </div>

  <div style="flex:1">
    <label>å‚™è¨»</label>
    <select id="tax_type" style="width:100%; height:32px; box-sizing:border-box;">
      <option value="æ‡‰ç¨…" selected>æ‡‰ç¨…</option>
      <option value="å…ç¨…">å…ç¨…</option>
      <option value="é›¶ç¨…ç‡">é›¶ç¨…ç‡</option>
    </select>
  </div>

  <div style="width:110px; display:flex; align-items:flex-end">
    <button id="addBtn" style="width:100%; height:32px;">åŠ å…¥æ˜ç´°</button>
  </div>
</div>



<div style="margin-top:10px;">
  <table id="tempTable">
    <thead>
      <tr>
        <th>åºè™Ÿ</th>
        <th>è¯å¼</th>
        <th>ç™¼ç¥¨æ—¥æœŸ</th>
        <th>åŸç™¼ç¥¨è™Ÿç¢¼</th>
        <th>å“å / èªªæ˜</th>
        <th>æ•¸é‡</th>
        <th>å–®åƒ¹ï¼ˆæœªç¨…ï¼‰</th>
        <th>æœªç¨…é‡‘é¡</th>
        <th>ç¨…é‡‘</th>
        <th>å«ç¨…é‡‘é¡</th>
        <th>å‚™è¨»</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tempBody">
      <tr><td colspan="12" class="center muted">å°šç„¡æ˜ç´°</td></tr>
    </tbody>
    <tfoot>
      <tr>
        <td colspan="7" class="right">åˆè¨ˆ</td>
        <td class="right" id="sumUntaxed">0.00</td>
        <td class="right" id="sumTax">0.00</td>
        <td class="right" id="sumTotal">0.00</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>


    <div style="display:flex; justify-content:space-between; gap:12px; margin-top:12px;">
      <button id="clearAll" class="secondary">æ¸…é™¤æ‰€æœ‰æš«å­˜</button>
      <div style="display:flex; gap:12px;">
        <button id="updatePreview">æ›´æ–°é è¦½</button>
        <button id="downloadPdf" style="background:#0b79d0">ä¸‹è¼‰ PDFï¼ˆå…±å››è¯ï¼‰</button>
      </div>
    </div>
  </div>

  <!-- right: preview -->
  <div class="panel preview-wrap">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div class="preview-title">å³æ™‚é è¦½</div>
        <div class="muted">è«‹ç¢ºèªå…§å®¹ï¼ŒæŒ‰ã€Œç¢ºèªä¸¦ä¸‹è¼‰ PDFã€æœƒç”¢ç”Ÿä¸€ä»½æŠ˜è®“å–®ï¼ˆæ¯é ä¸Šä¸‹å…©è¯ï¼‰ã€‚</div>
      </div>
      <div>
        <button id="downloadPdf2">ç¢ºèªä¸¦ä¸‹è¼‰ PDF</button>
      </div>
    </div>

    <div class="preview" id="previewArea" style="margin-top:12px;">
      <!-- A4 preview container (will be filled by JS) -->
      <div class="a4-container" id="previewPages">
        <!-- JS æœƒå‹•æ…‹ç”¢ç”Ÿ .a4page å…§å®¹ï¼ˆ2 pagesï¼‰ -->
      </div>
    </div>
    <div class="preview-note">æ¸¬è©¦ï¼šè‹¥ç³»çµ±æœ‰ã€Œæ¨™æ¥·é«”ã€å­—å‹ï¼Œé è¦½èˆ‡ PDF æœƒä½¿ç”¨æ¨™æ¥·é«”ã€‚</div>
  </div>
</div>

<script>
/* ---------- data & helpers ---------- */
let items = [];
const TAX_RATE = 0.05; // é è¨­ç‡Ÿæ¥­ç¨… 5%




function fmt(n){ 
  return Number(n||0).toLocaleString('zh-TW',{minimumFractionDigits:0, maximumFractionDigits:0}); 
}
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- table & preview update ---------- */
function refreshTempTable(){
  const tbody = document.getElementById('tempBody');
  tbody.innerHTML = '';
  if(items.length === 0){
    tbody.innerHTML = '<tr><td colspan="10" class="center muted">å°šç„¡æ˜ç´°</td></tr>';
  } else {
    let sumU=0, sumTax=0, sumWith=0;
    items.forEach((it, idx)=>{
const untaxed = Number(it.qty) * Number(it.price || 0);
let tax = 0;
if(it.tax_type === "æ‡‰ç¨…"){
    tax = Math.round(untaxed * TAX_RATE * 100) / 100;
} // å…ç¨…ã€é›¶ç¨…ç‡å°±æ˜¯ 0
const withtax = untaxed + tax;

      sumU += untaxed; sumTax += tax; sumWith += withtax;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${idx+1}</td>
        <td>${escapeHtml(it.inv_type)}</td>
        <td>${escapeHtml(it.inv_date || '')}</td>
        <td>${escapeHtml(it.inv_no)}</td>
        <td>${escapeHtml(it.desc)}</td>
        <td class="center">${it.qty}</td>
        <td class="right">${fmt(it.price)}</td>
        <td class="right">${fmt(untaxed)}</td>
        <td class="right">${fmt(tax)}</td>
        <td class="right">${fmt(withtax)}</td>
        <td>${escapeHtml(it.tax_type)}</td>

        <td class="center"><button onclick="removeItem(${idx})">åˆªé™¤</button></td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('sumUntaxed').innerText = fmt(sumU);
    document.getElementById('sumTax').innerText = fmt(sumTax);
    document.getElementById('sumTotal').innerText = fmt(sumWith);
  }
  buildPreview(); // æ›´æ–°é è¦½
}

function removeItem(i){ items.splice(i,1); refreshTempTable(); }

document.getElementById('addBtn').addEventListener('click',()=>{
  const inv_type = document.getElementById('inv_type').value.trim();
  const inv_date = document.getElementById('inv_date').value;
  const inv_no = document.getElementById('inv_no').value.trim();
  const desc = document.getElementById('item_desc').value.trim();
  const qty = Number(document.getElementById('item_qty').value) || 0;
  const price = Number(document.getElementById('item_price').value) || 0;
  const tax_type = document.getElementById('tax_type').value.trim();
  if(!desc || qty <= 0){ alert('è«‹è¼¸å…¥å“åèˆ‡æ•¸é‡'); return; }
  items.push({  inv_type,inv_date,inv_no, desc, qty, price,tax_type });
  document.getElementById('inv_type').value=''; document.getElementById('inv_date').value='';document.getElementById('inv_no').value=''; document.getElementById('item_desc').value=''; document.getElementById('item_qty').value=1; document.getElementById('item_price').value=0; document.getElementById('tax_type').value='æ‡‰ç¨…';
  refreshTempTable();
});
document.getElementById('clearAll').addEventListener('click', ()=>{ if(confirm('ç¢ºå®šæ¸…é™¤å…¨éƒ¨æš«å­˜ï¼Ÿ')){ items=[]; refreshTempTable(); }});
document.getElementById('updatePreview').addEventListener('click', ()=> buildPreview());

/* ---------- build preview HTML ---------- */
function buildPreview(){
  // get inputs
  const seller = { name: escapeHtml(document.getElementById('seller_name').value), tax: escapeHtml(document.getElementById('seller_tax').value), addr: escapeHtml(document.getElementById('seller_addr').value) };
  const buyer  = { name: escapeHtml(document.getElementById('buyer_name').value), tax: escapeHtml(document.getElementById('buyer_tax').value), addr: escapeHtml(document.getElementById('buyer_addr').value) };
  const nota_no = escapeHtml(document.getElementById('nota_no').value);
  const nota_date = escapeHtml(document.getElementById('nota_date').value);
  const nota_note = escapeHtml(document.getElementById('nota_note').value);

  // prepare items html + totals
  let rowsHtml = '';
  let sumU=0, sumTax=0, sumWith=0;
  if(items.length === 0){
    rowsHtml = `<tr><td colspan="9" class="center muted">ï¼ˆç„¡æ˜ç´°ï¼‰</td></tr>`;
  } else {
    items.forEach((it, idx)=>{
const untaxed = Number(it.qty) * Number(it.price || 0);
let tax = 0;
if(it.tax_type === "æ‡‰ç¨…"){
    tax = Math.round(untaxed * TAX_RATE * 100) / 100;
} // å…ç¨…ã€é›¶ç¨…ç‡ç¨…é‡‘ = 0
const withtax = untaxed + tax;

      sumU += untaxed; sumTax += tax; sumWith += withtax;
      rowsHtml += `<tr>
        <td>${idx+1}</td>
        <td>${escapeHtml(it.inv_type)}</td>
        <td>${escapeHtml(it.inv_date||'')}</td>
        <td>${escapeHtml(it.inv_no)}</td>
        <td>${escapeHtml(it.desc)}</td>
        <td class="center">${it.qty}</td>
        <td class="right">${fmt(it.price)}</td>
        <td class="right">${fmt(untaxed)}</td>
        <td class="right">${fmt(tax)}</td>
        <td class="right">${fmt(withtax)}</td>
        <td>${escapeHtml(it.tax_type)}</td>
      </tr>`;
    });
  }

  // build two pages, each page contains two copies (upper & lower)
  const copyTitles = [
    'ç¬¬ä¸€è¯:äº¤ä»˜åŸéŠ·è²¨äººä½œç‚ºéŠ·é …ç¨…é¡ä¹‹æ‰£æ¸›æ†‘è­‰',
    'ç¬¬äºŒè¯:äº¤ä»˜åŸéŠ·è²¨äººä½œç‚ºéŠ·é …ç¨…é¡ä¹‹è¨˜å¸³æ†‘è­‰',
    'ç¬¬ä¸‰è¯:ç”±é€²è²¨äººä½œç‚ºé€²é …ç¨…é¡ä¹‹æ‰£æ¸›æ†‘è­‰',
    'ç¬¬å››è¯:ç”±é€²è²¨äººä½œç‚ºè¨˜å¸³æ†‘è­‰'
  ];

  const previewPages = document.getElementById('previewPages');
  previewPages.innerHTML = ''; // clear

  // create page builder (page holds two copies)
  function makePage(startIndex){
    const copyHtml = (index) => `
      <div class="copy" data-copy-index="${index}">
        <div class="title-center">ç‡Ÿæ¥­äººéŠ·è²¨é€€å›é€²è²¨é€€å‡ºæˆ–æŠ˜è®“è­‰æ˜å–®</div>
        <div class="hdr">
          <div class="left">

<div style="font-weight:700">åŸé–‹ç«‹éŠ·è²¨ç™¼ç¥¨å–®ä½</div>

 <div>å    ç¨±ï¼š${seller.name}</div>
 <div>çµ±ä¸€ç·¨è™Ÿï¼š${seller.tax}</div> 
 <div>ç‡Ÿæ¥­åœ°å€ï¼š${seller.addr}</div>

</div>


<div class="right" style="text-align:left;">

  <div style="font-weight:500; font-size:10px">${escapeHtml(copyTitles[index])}</div>
  <div>æŠ˜è®“æ—¥æœŸï¼š${nota_date || ''}</div>
  <div style="margin-top:10px">æŠ˜è®“å–®ç·¨è™Ÿï¼š${nota_no || ''}</div>
  <div style="margin-top:10px">å‚™      è¨»ï¼š${nota_note || ''}</div>


          </div>
        </div>


        <table class="items-table">
          <thead>
<tr>
<th>åºè™Ÿ</th>
<th>è¯å¼</th>
<th>ç™¼ç¥¨<br>æ—¥æœŸ</th>
<th>ç™¼ç¥¨<br>è™Ÿç¢¼</th>
<th>å“å<br> / èªªæ˜</th>
<th>æ•¸é‡</th>
<th>å–®åƒ¹ï¼ˆæœªç¨…ï¼‰</th>
<th>æœªç¨…<br>é‡‘é¡</th>
<th>ç‡Ÿæ¥­<br>ç¨…é¡</th>
<th>å«ç¨…<br>é‡‘é¡</th>
<th>å‚™è¨»</th>
</tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="7" class="right">åˆè¨ˆ</td>
              <td class="right">${fmt(sumU)}</td>
              <td class="right">${fmt(sumTax)}</td>
              <td class="right">${fmt(sumWith)}</td>
            </tr>
          </tfoot>
        </table>

<div style="text-align:left; margin-top:5px; font-size:10px;">
  æœ¬è­‰æ˜å–®æ‰€åˆ—éŠ·è²¨é€€å›é€€å‡ºæˆ–æŠ˜è®“ï¼Œç¢ºå±¬äº‹å¯¦ï¼Œç‰¹æ­¤è­‰æ˜ã€‚
</div>


<div class="bottom" style="width:100%; margin-top:12px;">
  <div class="left-block" style="width:50000%; border:2px solid red; padding:12px; box-sizing:border-box; height:100px;">

            <div style="font-weight:700">åŸé€²è²¨äººç‡Ÿæ¥­äºº(æˆ–åŸè²·å—äºº)</div>

            <div>åç¨±ï¼š${buyer.name}</div>

            <div>çµ±ä¸€ç·¨è™Ÿ(æˆ–èº«åˆ†è­‰å­—è™Ÿ)ï¼š${buyer.tax}</div>

            <div>åœ°å€ï¼š${buyer.addr}</div>


<div style="text-align:right; margin-top:0px">
  (è“‹ç« æˆ–ç°½å)

</div>



            ${nota_note ? `<div style="margin-top:10px;">å‚™è¨»ï¼š${nota_note}</div>` : ''}
          </div>

          <div class="right-block"></div>
        </div>


<div style="text-align:left; margin-top:5px; font-size:10px;">
æ³¨æ„äº‹é …ï¼š
</div>
<div style="text-align:left; margin-top:5px; font-size:10px;">
ä¸€ã€ç´…è‰²æ¡†æ¡†ç‚º"å¿…å¡«æ¬„ä½"ã€‚
</div>
<div style="text-align:left; margin-top:5px; font-size:10px;">
äºŒã€åŸé–‹ç«‹å…¬å¸ç™¼ç¥¨è€…ï¼Œè«‹åŠ è“‹å…¬å¸ç™¼ç¥¨ç« ï¼Œå¯„å›æœ¬å…¬å¸å³å¯ã€‚
</div>
<div style="text-align:left; margin-top:5px; font-size:10px;">
ä¸‰ã€åŸé–‹ç«‹å€‹äººç™¼ç¥¨è€…ï¼Œè«‹å¡«å¯«æœ¬å–®å¿…å¡«æ¬„ä½ï¼Œä¸¦åŠ ã€Œå€‹äººç§ç« ã€å¯„å›æœ¬å…¬å¸å³å¯ã€‚
</div>




  <!-- å³å´ç›´æ›¸ -->
  <div class="vertical-label">

  </div>
</div>

	

    `;
    // two copies per page: startIndex and startIndex+1
    const pageHtml = `
<div class="a4page">
<div class="page-grid">
${copyHtml(startIndex)}
${copyHtml(startIndex+1)}
</div>

<!-- æ¯é ä¸­é–“çš„è™›ç·šï¼ˆæœƒä»¥ a4page ç‚ºåŸºæº–ï¼‰ -->
    <div class="page-divider"></div>

</div>`;
    previewPages.insertAdjacentHTML('beforeend', pageHtml);
  }

  makePage(0); // page1: copies 0 & 1
  makePage(2); // page2: copies 2 & 3
}

/* ---------- PDF generation (render each .a4page via html2canvas -> add to jsPDF) ---------- */
async function generatePdfByPages(){
  const { jsPDF } = window.jspdf;
  const pages = Array.from(document.querySelectorAll('#previewPages .a4page'));
  if(pages.length===0){ alert('é è¦½å°šæœªå»ºç«‹ï¼Œè«‹å…ˆæŒ‰æ›´æ–°é è¦½'); return; }

  // create jsPDF doc (mm)
  const pdf = new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
  for(let i=0;i<pages.length;i++){
    const el = pages[i];
    // ensure element has white background for clean capture
    el.style.background = '#fff';
    // render to canvas
    const canvas = await html2canvas(el, { scale:2, useCORS:true, backgroundColor: null });
    const imgData = canvas.toDataURL('image/png');
    // calculate image size in mm to fit A4
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const imgWidth = pdfWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    if(i>0) pdf.addPage();
    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
  }

  const nota_no = document.getElementById('nota_no').value || '';
  const filename = nota_no ? `æŠ˜è®“å–®_${nota_no}.pdf` : `æŠ˜è®“å–®.pdf`;
  pdf.save(filename);
}

/* ---------- events ---------- */
document.getElementById('downloadPdf').addEventListener('click', async ()=>{
   // å¥—ç”¨ PDF å°ˆç”¨ CSS
  // ensure preview is up-to-date
  document.body.classList.add('pdf-mode');

  // é‡æ–°ç”Ÿæˆé è¦½ï¼Œç¢ºä¿ç¸®å°å­—é«”ç”Ÿæ•ˆ
  buildPreview();

  // ç­‰ 0.3 ç§’å¾Œç”Ÿæˆ PDF
  // wait a tick for rendering
  setTimeout(()=>{
    generatePdfByPages();

 // PDF ç”Ÿæˆå®Œæˆå¾Œç§»é™¤ PDF CSSï¼ˆé¸æ“‡æ€§ï¼‰
  document.body.classList.remove('pdf-mode');




 }, 300);
});



document.getElementById('downloadPdf2').addEventListener('click', ()=>{


  // same action for other button
  document.getElementById('downloadPdf').click();
});



/* init */
refreshTempTable();
buildPreview();

</script>
</body>
</html>
